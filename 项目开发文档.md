# A萌小测应用开发文档

## 1. 项目概述

### 1.1 项目基本信息
- **应用名称**：A萌小测
- **应用类型**：班级云小测文件管理系统
- **开发框架**：uni-app + Vue 3
- **支持平台**：Android、iOS、鸿蒙（HarmonyOS）、H5
- **项目路径**：`i:/Data-数据区/应用/自制/云TW/云汤巍词组/`

### 1.2 核心功能
1. **用户认证**：登录/登出功能
2. **文件管理**：小测文件上传、存储、管理
3. **加密系统**：文件安全加密与解密
4. **权限控制**：基于角色的功能访问权限

## 2. 项目结构

```
├── pages/                    # 页面目录
│   ├── profile/             # 用户相关页面
│   │   └── my.vue           # 用户中心与文件上传（核心页面）
│   └── login/               # 登录页面
│       └── login.vue
├── utils/                   # 工具类
│   └── fileCrypto.js        # 文件加密工具类
├── uni_modules/             # 第三方插件
│   └── sr-file-choose/      # 跨平台文件选择插件
├── manifest.json            # 应用配置文件
└── package.json             # 项目依赖配置
```

## 3. 核心功能实现

### 3.1 文件选择功能

#### 3.1.1 插件集成
- **插件名称**：sr-file-choose
- **插件类型**：UTS插件（支持多平台）
- **安装方式**：通过uni-app插件市场导入
- **导入路径**：`import { chooseFileFromModule } from '../../uni_modules/sr-file-choose'`

#### 3.1.2 调用方式
```javascript
chooseFileFromModule({
  complete: (res) => {
    if (res && res.path) {
      // 处理文件选择结果
      this.selectedFile = res.path
      this.selectedFileName = res.name
    }
  }
})
```

#### 3.1.3 关键参数
- **res.path**：选择的文件路径
- **res.name**：文件名
- **res.size**：文件大小

#### 3.1.4 降级策略
```javascript
// 插件不可用时的降级方案
if (!pluginAvailable) {
  if (uni.chooseFile) {
    // 使用uni-app API
    uni.chooseFile({ ... })
  } else if (uni.chooseMessageFile) {
    // 使用微信小程序API
    uni.chooseMessageFile({ ... })
  } else if (typeof document !== 'undefined') {
    // H5环境下的备选方案
    const input = document.createElement('input')
    input.type = 'file'
    // ...
  }
}
```

### 3.2 文件加密系统

#### 3.2.1 核心类与方法
```javascript
class FileCrypto {
  constructor(key) { ... }
  _xorEncrypt(arrayBuffer) { ... }  // XOR加密
  _xorDecrypt(arrayBuffer) { ... }  // XOR解密（与加密相同）
  encryptFile(input, fileName) { ... }  // 文件转ASCII
  decryptText(text, outputDir) { ... }  // ASCII转文件
  static generateRandomKey(length) { ... }  // 生成密钥
}
```

#### 3.2.2 加密流程
1. **输入处理**：判断是文件路径还是文件内容
2. **ArrayBuffer转换**：将文件转换为二进制数据
3. **XOR加密**：使用密钥对数据进行加密
4. **Base64编码**：将加密数据转换为可传输的字符串
5. **头部信息**：添加文件名等元数据

#### 3.2.3 关键API依赖
- **uni.getFileSystemManager()**：文件系统操作
- **uni.arrayBufferToBase64()**：二进制数据转Base64
- **uni.base64ToArrayBuffer()**：Base64转二进制数据

#### 3.2.4 兼容性处理
```javascript
// TextEncoder兼容
let arrayBuffer;
if (typeof TextEncoder !== 'undefined') {
  const encoder = new TextEncoder();
  arrayBuffer = encoder.encode(input);
} else {
  // 兼容不支持TextEncoder的环境
  const binaryString = input;
  const len = binaryString.length;
  arrayBuffer = new ArrayBuffer(len);
  const bytes = new Uint8Array(arrayBuffer);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
}

// Base64转换兼容
let base64String;
if (uni && uni.arrayBufferToBase64) {
  base64String = uni.arrayBufferToBase64(encryptedBuffer);
} else if (typeof btoa !== 'undefined') {
  base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(encryptedBuffer)));
} else {
  throw new Error('当前环境不支持Base64转换');
}
```

### 3.3 文件上传功能

#### 3.3.1 上传API信息
- **API端点**：`https://data.520ai.cc/bases/bseeA4QIJT6Jt3AQVJw/tables/tVHdsNomxx`
- **请求方法**：POST
- **认证方式**：`x-bm-token` 请求头部
- **Content-Type**：`application/json`

#### 3.3.2 上传数据结构
```javascript
const uploadData = {
  date: this.testTime,        // 小测日期（格式：yyyy-mm-dd）
  sub: this.subject,          // 科目
  file: encryptedText,        // 加密后的文件内容
  filename: this.selectedFileName,  // 文件名
  created_by: this.userInfo?.id || 'unknown',  // 创建者ID
  created_at: new Date().toISOString()  // 创建时间
}
```

#### 3.3.3 上传实现代码
```javascript
const response = await uni.request({
  url: 'https://data.520ai.cc/bases/bseeA4QIJT6Jt3AQVJw/tables/tVHdsNomxx',
  method: 'POST',
  header: {
    'x-bm-token': token,
    'Content-Type': 'application/json'
  },
  data: uploadData
})
```

#### 3.3.4 响应处理
```javascript
if (response.statusCode === 200 && response.data) {
  // 上传成功
  uni.showToast({ title: '上传成功', icon: 'success' })
  this.closeUploadModal()
} else if (response.statusCode === 307 && response.header?.location?.includes('/login')) {
  // 登录过期处理
  uni.showToast({ title: '登录已过期，请重新登录', icon: 'none' })
  uni.removeStorageSync('userToken')
  setTimeout(() => {
    uni.reLaunch({ url: '/pages/login/login' })
  }, 2000)
} else {
  // 其他错误
  uni.showToast({ title: `上传失败: ${response.statusCode}`, icon: 'none' })
}
```

### 3.4 用户认证系统

#### 3.4.1 认证流程
1. **登录**：用户输入凭证，获取token
2. **存储**：将token保存在本地存储
3. **验证**：API请求时携带token
4. **过期处理**：检测token有效性，自动跳转登录

#### 3.4.2 关键代码
```javascript
// 保存token
uni.setStorageSync('userToken', token)

// 获取token
const token = uni.getStorageSync('userToken')

// 登出
uni.removeStorageSync('userToken')
uni.removeStorageSync('userInfo')
```

## 4. 权限管理

### 4.1 应用权限配置

#### 4.1.1 Android权限
```json
// manifest.json
"android": {
  "permissions": [
    "<uses-permission android:name=\"android.permission.READ_EXTERNAL_STORAGE\" />",
    "<uses-permission android:name=\"android.permission.WRITE_EXTERNAL_STORAGE\" />",
    "<uses-permission android:name=\"android.permission.MANAGE_EXTERNAL_STORAGE\" />"
  ]
}
```

#### 4.1.2 HarmonyOS权限
```javascript
// 动态请求权限
const abilityAccessCtrl = uni.requireNativePlugin('abilityAccessCtrl')
const atManager = abilityAccessCtrl.createAtManager()
const status = await atManager.checkPermission(tokenId, 'ohos.permission.READ_USER_STORAGE')
if (status !== abilityAccessCtrl.GrantStatus.PERMISSION_GRANTED) {
  await atManager.requestPermissionsFromUser(this.$scope.$getAppWebview().getContext(), ['ohos.permission.READ_USER_STORAGE'])
}
```

### 4.2 功能权限控制
```javascript
// 检查用户权限
if (this.userInfo && this.userInfo.Key === 'system') {
  this.isSystemUser = true  // 系统管理员权限
}

// 模板中控制显示
<view class="function-item" v-if="isSystemUser" @click="handleUpload">
  <text class="function-text">⬆️ 上传</text>
</view>
```

## 5. 错误处理与调试

### 5.1 错误类型与处理

| 错误类型 | 错误表现 | 处理方式 |
|---------|---------|---------|
| 307重定向 | 登录过期 | 自动跳转登录页 |
| 文件权限 | 无法读取文件 | 动态请求权限 |
| API调用失败 | 网络错误 | 显示错误提示 |
| 模块不存在 | 插件未加载 | 降级到其他方案 |

### 5.2 日志系统

#### 5.2.1 日志分级
- **INFO**：普通信息，如功能调用开始
- **DEBUG**：详细调试信息，如参数、返回值
- **WARN**：警告信息，如非致命错误
- **ERROR**：错误信息，如致命异常

#### 5.2.2 关键日志点
```javascript
// 文件选择日志
console.log('sr-file-choose选择结果:', JSON.stringify(res))

// 加密日志
console.log('开始加密文件，输入类型:', typeof input, '文件名:', fileName)

// 上传日志
console.log('开始发送上传请求，URL:', 'https://data.520ai.cc/bases/bseeA4QIJT6Jt3AQVJw/tables/tVHdsNomxx')
console.log('上传请求响应:', JSON.stringify({
  statusCode: response.statusCode,
  data: response.data ? `[数据长度: ${JSON.stringify(response.data).length}]` : null
}))
```

## 6. 性能优化

### 6.1 加密性能优化
1. **异步处理**：使用Promise处理加密过程
2. **内存管理**：及时释放不再使用的Buffer对象
3. **批量处理**：大文件分块处理

### 6.2 网络优化
1. **请求合并**：减少API调用次数
2. **超时控制**：设置合理的请求超时时间
3. **重试机制**：网络失败时自动重试

### 6.3 用户体验优化
1. **加载提示**：操作过程中显示加载状态
2. **进度反馈**：长时间操作提供进度信息
3. **错误提示**：友好的错误信息展示

## 7. 常见问题与解决方案

### 7.1 文件选择问题

#### 问题1：插件调用失败
- **原因**：插件未正确导入或配置
- **解决方案**：
  1. 检查插件是否在uni_modules目录下
  2. 确认导入路径正确
  3. 重新编译自定义基座

#### 问题2：文件路径格式不一致
- **原因**：不同平台文件路径格式不同
- **解决方案**：
  ```javascript
  const slashIndex = input.lastIndexOf('/')
  const backslashIndex = input.lastIndexOf('\\')
  const extractedFileName = input.substring(Math.max(slashIndex, backslashIndex) + 1)
  ```

### 7.2 加密问题

#### 问题1：TextEncoder不可用
- **原因**：某些环境不支持TextEncoder API
- **解决方案**：
  ```javascript
  let arrayBuffer;
  if (typeof TextEncoder !== 'undefined') {
    const encoder = new TextEncoder();
    arrayBuffer = encoder.encode(input);
  } else {
    // 兼容方案
    const binaryString = input;
    const len = binaryString.length;
    arrayBuffer = new ArrayBuffer(len);
    const bytes = new Uint8Array(arrayBuffer);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
  }
  ```

#### 问题2：Base64转换失败
- **原因**：平台差异导致转换方法不同
- **解决方案**：
  ```javascript
  let base64String;
  if (uni && uni.arrayBufferToBase64) {
    base64String = uni.arrayBufferToBase64(encryptedBuffer);
  } else if (typeof btoa !== 'undefined') {
    base64String = btoa(String.fromCharCode.apply(null, new Uint8Array(encryptedBuffer)));
  } else {
    throw new Error('当前环境不支持Base64转换');
  }
  ```

### 7.3 上传问题

#### 问题1：307重定向
- **原因**：用户token过期
- **解决方案**：
  ```javascript
  if (response.statusCode === 307 && response.header?.location?.includes('/login')) {
    uni.showToast({ title: '登录已过期，请重新登录', icon: 'none' })
    uni.removeStorageSync('userToken')
    setTimeout(() => {
      uni.reLaunch({ url: '/pages/login/login' })
    }, 2000)
  }
  ```

#### 问题2：API URL错误
- **原因**：URL路径不正确
- **解决方案**：使用正确的API端点 `https://data.520ai.cc/bases/bseeA4QIJT6Jt3AQVJw/tables/tVHdsNomxx`（**无/records后缀**）

## 8. 开发规范与最佳实践

### 8.1 代码规范
1. **命名规范**：
   - 变量：小驼峰命名法
   - 函数：小驼峰命名法
   - 组件：大驼峰命名法
2. **注释规范**：
   - 关键函数添加文档注释
   - 复杂逻辑添加说明
   - 变量用途注释
3. **格式规范**：
   - 使用4个空格缩进
   - 语句结尾使用分号
   - 适当的空行分隔代码块

### 8.2 安全规范
1. **数据安全**：
   - 敏感数据加密存储
   - 网络请求使用HTTPS
   - 避免明文存储密码
2. **权限安全**：
   - 最小权限原则
   - 动态请求必要权限
   - 验证用户输入
3. **API安全**：
   - 使用token认证
   - 添加请求签名
   - 限制请求频率

### 8.3 开发流程
1. **需求分析**：明确功能需求和技术要求
2. **设计阶段**：架构设计、UI设计、API设计
3. **开发阶段**：功能实现、单元测试
4. **测试阶段**：功能测试、兼容性测试
5. **发布阶段**：打包、发布、更新

## 9. 后续开发计划

### 9.1 功能扩展
1. **批量上传**：支持同时上传多个文件
2. **文件预览**：小测文件在线预览
3. **历史记录**：查看上传历史
4. **统计功能**：小测数据统计分析

### 9.2 技术优化
1. **加密算法升级**：从XOR升级到AES
2. **缓存系统**：添加文件缓存机制
3. **离线支持**：支持离线上传
4. **性能监控**：添加性能监控工具

### 9.3 平台适配
1. **小程序支持**：添加微信/支付宝小程序支持
2. **桌面端支持**：添加Windows/macOS支持
3. **国际化**：支持多语言切换

## 10. 联系方式与支持

- **开发人员**：
- **联系邮箱**：
- **技术支持**：

## 11. 更新日志

### 1.0.0（2026-01-10）
- 初始版本发布
- 核心功能实现
- 多平台支持

---

**文档更新日期**：2026-01-10
**文档版本**：1.0.0